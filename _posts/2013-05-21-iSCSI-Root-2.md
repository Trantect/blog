---
published: true
layout: post
title: iSCSI Root (part 2)
categories:
  - blog
tags:
  - iSCSI
  - ipxe
  - lvm
  - diskless environment

---
In our previous post [iSCSI Root (part 1)](/blog/2013/05/20/iSCSI-Root/), we setup TFTP and dhcp services. In this post, we will go further.

## Setup iet service and intergrate lvm
First, we need to setup the iet(iSCSI Enterprise Target).

```
$ apt-get install iscsitarget
```

Edit the `/etc/default/iscsitarget` in your favorite text editor and set `ISCSITARGET_ENABLE=true`.

Then you need to add your iscsi target. We will use block devices which created by LVM as the iscsi lun device. We use lvm because we want to be benifit from it's powerful disk managing ability.

Now, let's create the LVM volumes in our disk. Before this, you should get to know [how to use lvm](http://tldp.org/HOWTO/LVM-HOWTO/).

We create a volume with 10G size in trantect volume group.

```
$ lvcreate -L 10G -n trantect os-iscsi
```

An block device whose path is `/dev/trantect/os-iscsi` is created. Then, add the volume into iet targets by editing `/etc/iet/ietd.conf`.

<pre><code>Target iqn.2013-05.com.trantect:storage.os-iscsi
        Lun 0 Path=/dev/trantect/os-iscsi,Type=blockio
        Alias LUNOISCSI</code></pre>

So the volume `/dev/trantect/os-iscsi` has been exported as a iSCSI target. Of course, you can add other volumes as many as you want. Once finished the iet configuration, you can restart the iet service.

```
$ service iscisitarget restart
```

Now, you can check the running iSCSI targets by this command.

```
$ cat /proc/net/iet/volume
```

The output is always like this.
<pre><code>tid:1 name:iqn.2013-05.com.trantect:storage.os-iscsi
	lun:0 state:0 iotype:blockio iomode:wt blocks:83886080 blocksize:512 path:/dev/trantect/os-iscsi</code></pre>

## Install OS into lvm volume

We have got our iet service running. Howerver, the volume is still a blank device without any OS in it. So the next thing is installing OS.

### Install Ubuntu
You can follow this two links [Initiating a connection to an iSCSI disk in Ubuntu](http://www.heath-bar.com/blog/?p=243), [Install & Configure Ubuntu to boot from an iSCSI disk](http://www.heath-bar.com/blog/?p=267). It is a nice tutorial about how to install Ubuntu into a iSCSI disk.

NOTE:There are a few things must been done after you install the Ubuntu.

* Configure the initrd process to connect to the iSCSI disk before it does anything else.
* Switch the network configuration to manual.
* Update GRUB to pass the iSCSI parameters to the kernel at boot time.

### Install Windows 7
You can follow this tutorial [Diskless Windows 7 iSCSI boot from OpenSolaris 2009.06 ZFS Server](http://blog.zorinaq.com/?e=41)

NOTES:

* In theory,Vista/2008/2008 R2 are also supported. But we didn't test yet.
* Windows 7 has poor support for gigablit ethernet. That means, we can not get an better performance though all machines are using gigablit ethernet.

## Other resources
* [iPXE documents](http://ipxe.org/docs)
* [PXE Booting Ubuntu from an iSCSI drive](http://www.heath-bar.com/blog/?p=184)
* [Diskless Windows 7 with iSCSI and gPXE](http://jonmccune.wordpress.com/2011/12/19/diskless-windows-7-with-iscsi-and-gpxe/)
* [Windows XP/Vista/7 iSCSI Boot](http://www.thogan.com/blog/windows-xp-vista-7-iscsi-boot/)
* [Installing Windows Server 2008 to an iSCSI target](http://www.etherboot.org/wiki/sanboot/win2k8_iscsi_install)
* [Diskless Windows 7 iSCSI boot from OpenSolaris 2009.06 ZFS Server](http://blog.zorinaq.com/?e=41)
